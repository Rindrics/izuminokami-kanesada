# ADR-0024: セグメント単位の音声生成戦略

## ステータス

提案中

## コンテキスト

古典テキストの学習において、ユーザーが特定のセグメント（発言単位）を繰り返し聞いて練習したいというニーズがある。現在の実装では章単位で1つのオーディオファイルを生成しているため、特定のセグメントだけを再生することができない。セグメント単位での再生を実現するには、セグメントごとに個別のオーディオファイルを生成する必要がある。

### 要件

1. **セグメント単位の再生**: ユーザーは特定のセグメントまたはセグメント範囲を選択して再生できる
2. **範囲選択**: 複数のセグメントを連続して選択し、範囲再生できる
3. **効率的な生成**: セグメントごとに個別のTTS API呼び出しを行う
4. **後方互換性**: 既存のオーディオファイルとの互換性を考慮（移行期間）

## 決定

**セグメントごとに個別のオーディオファイルを生成し、マニフェストでセグメント単位のメタデータを管理する**。

### マニフェスト構造の変更

#### 現在の構造（章単位）

```json
{
  "lunyu/1/1": {
    "zh": { "uploadedAt": "...", "hash": "..." },
    "ja": { "uploadedAt": "...", "hash": "..." }
  }
}
```

#### 新しい構造（セグメント単位）

```json
{
  "lunyu/1/1": {
    "segments": [
      {
        "index": 0,
        "zh": { "uploadedAt": "...", "hash": "..." },
        "ja": { "uploadedAt": "...", "hash": "..." }
      },
      {
        "index": 1,
        "zh": { "uploadedAt": "...", "hash": "..." },
        "ja": { "uploadedAt": "...", "hash": "..." }
      }
    ]
  }
}
```

### ファイル命名規則

- **現在**: `{chapterId}-{lang}.mp3` (例: `1-zh.mp3`)
- **新規**: `{chapterId}-{segmentIndex}-{lang}.mp3` (例: `1-0-zh.mp3`, `1-1-zh.mp3`)

### Firebase Storage 構造

```text
audio/
├── lunyu/
│   ├── 1/
│   │   ├── 1-0-zh.mp3  (セグメント 0)
│   │   ├── 1-0-ja.webm
│   │   ├── 1-1-zh.mp3  (セグメント 1)
│   │   ├── 1-1-ja.webm
│   │   └── ...
│   └── ...
└── ...
```

### 生成ワークフロー

```text
1. YAML ファイルからセグメントを読み込み
2. 各セグメントごとに:
   a. セグメントのテキストを SSML に変換
   b. Google Cloud TTS で音声生成
   c. ファイル保存: {chapterId}-{index}-{lang}.mp3
   d. マニフェストにエントリ追加
3. マニフェストを保存
```

### URL 生成

```typescript
// セグメント単位のURL生成
function getSegmentAudioUrl(
  bookId: string,
  sectionId: string,
  chapterId: string,
  segmentIndex: number,
  lang: AudioLanguage
): string {
  const ext = lang === 'zh' ? 'mp3' : 'webm';
  return `${AUDIO_BASE_URL}/audio/${bookId}/${sectionId}/${chapterId}-${segmentIndex}-${lang}.${ext}`;
}
```

## 根拠

### セグメント単位生成を採用する理由

| 観点 | 効果 |
|------|------|
| **ユーザー体験** | 特定のセグメントだけを繰り返し聞いて練習できる |
| **柔軟性** | 任意のセグメント範囲を選択して再生可能 |
| **実装の明確性** | セグメントとオーディオファイルの1対1対応 |
| **仕様との整合性** | TLA+ モデル（[models/AudioPlayer.tla](../models/AudioPlayer.tla)）で定義したセグメント単位再生の仕様と一致 |

### 章単位生成を継続しない理由

| 課題 | 影響 |
|------|------|
| **ユーザーニーズを満たせない** | 特定のセグメントだけを繰り返し聞くことができない |
| **範囲選択の実装が複雑** | Web Audio API でタイムスタンプ管理が必要 |
| **セグメント境界の検知が困難** | 正確なセグメント境界を特定するのが難しい |

## 影響

### 既存コンテンツの移行

既存の章単位オーディオファイルは、以下のいずれかの方法で移行する：

1. **再生成**: 既存の YAML からセグメント単位で再生成（推奨）
2. **段階的移行**: 新規コンテンツはセグメント単位、既存は章単位のまま（一時的）

### 変更が必要なファイル

1. **scripts/generate-audio.ts**: セグメント単位の生成ロジックに変更
2. **src/lib/audio.ts**: セグメント単位のURL生成に対応
3. **audio-manifest.json**: 構造変更（移行スクリプトが必要）
4. **scripts/upload-audio.ts**: セグメント単位のアップロードに対応
5. **scripts/validate-audio-manifest.ts**: セグメント単位のバリデーションに対応

### コストへの影響

- **TTS API 呼び出し回数**: 章あたりの呼び出し数がセグメント数に比例して増加
- **ストレージ容量**: ファイル数が増加するが、1ファイルあたりのサイズは小さくなる
- **ネットワーク**: セグメント単位でロードするため、必要なセグメントのみダウンロード可能

## 代替案

### A: 章単位ファイル + タイムスタンプ情報

章単位のファイルを維持し、各セグメントの開始/終了時刻をマニフェストに記録する。

**却下理由**:
- Web Audio API でのタイムスタンプ管理が複雑
- セグメント境界の正確な検知が困難
- ユーザーが特定のセグメントだけを繰り返し聞くというニーズを満たしにくい

### B: ハイブリッド方式

章単位ファイルとセグメント単位ファイルの両方を生成し、用途に応じて使い分ける。

**却下理由**:
- ストレージ容量の無駄
- 管理が複雑になる
- コストが2倍になる

## 関連

- [ADR-0017: 音声マニフェスト戦略](./0017-audio-manifest-strategy.md)
- [ADR-0018: 音声生成戦略](./0018-audio-generation-strategy.md)
- [ADR-0019: 音声生成ワークフロー](./0019-audio-generation-workflow.md)
- [models/AudioPlayer.tla](../models/AudioPlayer.tla) - セグメント単位再生の仕様を定義した TLA+ モデル
