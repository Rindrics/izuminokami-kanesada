# ADR-0006: コンテンツストレージ戦略

## ステータス

承認済み

## コンテキスト

ADR-0003 では Firebase + Next.js の構成を採用し、Firestore をデータベースとして使用する方針を決定した。しかし、実際の運用を検討した結果、コンテンツデータとユーザーデータで最適なストレージ方法が異なることが判明した。

### 検討事項

1. **コンテンツの特性**
   - 四書五経のテキストは変更頻度が低い
   - バージョン管理・差分確認が重要

2. **ユーザーデータの特性**
   - コメント、お気に入りなどユーザーごとのデータ
   - リアルタイム更新が望ましい
   - ユーザー認証と連携

### 検討した選択肢

#### 選択肢 A: 全データを Firestore で管理

```text
Firestore
├── books/
├── contents/
├── characters/
├── hanzi/
├── comments/      (ユーザーデータ)
└── favorites/     (ユーザーデータ)
```

**メリット**:
- 統一的なデータアクセス
- リアルタイム更新

**デメリット**:
- ローカル開発でエミュレーター起動が必要
- コンテンツの差分管理が困難

#### 選択肢 B: コンテンツはプレーンテキスト、ユーザーデータは Firestore

```text
Git リポジトリ (プレーンテキスト)
├── src/data/
│   ├── contents/      # 書籍コンテンツ
│   ├── characters/    # 人物データ
│   └── hanzi/         # 漢字辞書

Firestore (ユーザーデータ)
├── comments/
├── favorites/
└── users/
```

**メリット**:
- コンテンツの Git 管理（差分、履歴、レビュー）
- ローカル開発が簡単（エミュレーター不要）
- ユーザーデータはリアルタイム更新可能

**デメリット**:
- 2種類のデータソースを管理

## 決定

**選択肢 B** を採用する。

### データ管理方針

| データ種別 | ストレージ | 理由 |
|-----------|-----------|------|
| 書籍コンテンツ | Git (JSON/TS) | 変更頻度低、バージョン管理重要 |
| 人物データ | Git (JSON/TS) | 同上 |
| 漢字辞書 | Git (JSON/TS) | 同上 |
| ユーザーコメント | Firestore | リアルタイム、ユーザー認証連携 |
| お気に入り | Firestore | リアルタイム、ユーザー認証連携 |

### ディレクトリ構造

```text
src/data/
├── contents/
│   └── lunyu/           # 論語
│       ├── index.json   # 書籍メタデータ
│       └── sections/
│           └── 1/       # 学而第一
│               ├── index.json  # 編メタデータ
│               └── chapters/
│                   ├── 1.json  # 第1章
│                   └── 2.json  # 第2章
├── characters/
│   └── index.json       # 人物一覧
└── hanzi/
    └── dictionary.json  # 漢字辞書
```

### コンテンツ更新フロー

```text
1. コンテンツを生成（JSON 形式）
2. PR を作成
3. レビュー（差分確認）
4. マージ
5. CI でビルド → デプロイ
```

## 結果

### メリット

1. **Git によるバージョン管理**: 全変更履歴を追跡、差分レビューが可能
2. **開発体験の向上**: エミュレーター不要、即座に開発開始可能
3. **関心の分離**: 静的コンテンツと動的ユーザーデータを明確に分離

### 考慮事項

1. **コンテンツ量**: 四書五経全体で約 2,000 章、16MB 程度は Git で問題なく管理可能
2. **ビルド時間**: コンテンツ増加に伴いビルド時間が増加する可能性。必要に応じて ISR を検討
3. **検索機能**: 全文検索には Algolia や Meilisearch などの外部サービスを検討

### ADR-0003 との関係

ADR-0003 の「Firestore をデータベースとして使用」という方針を、より具体的に「ユーザーデータに限定して使用」と明確化した。コンテンツの SSG 生成という基本方針は維持する。
