# ADR-0010: コンテンツバリデーション戦略

## ステータス

採用

## コンテキスト

ADR-0009 で決定した AI コンテンツ生成戦略に基づき、`validateContent()` 関数を実装した。この関数は Content データの構造・整合性・ADR-0007 接続マーカー規約への準拠をチェックする。

### 問題

バリデーション関数の使い方について方針を決める必要がある：

1. **全コンテンツをテストで検証**: コンテンツが増えるたびにテストが肥大化し、実行時間が長くなる
2. **バリデーター自体のテスト**: ロジックの正しさを検証するが、実際のコンテンツは検証しない

### 検討した選択肢

| 選択肢 | メリット | デメリット |
|--------|----------|------------|
| A: テストで全コンテンツを検証 | 明示的、失敗時のフィードバックが詳細 | テストが肥大化、コンテンツ追加のたびに遅くなる |
| B: ビルド時に全検証 | CI で自動化、テストと分離 | ローカルでのフィードバックが遅い、全件検証は非効率 |
| C: CI で差分のみ検証 | 効率的、テストと分離、スケールする | 既存コンテンツの回帰検出が難しい |
| D: pre-commit hook | コミット前に即座にフィードバック | hook が重くなる可能性 |

## 決定

**選択肢 C: CI で差分のみ検証** を採用する。

### 根拠

1. **スケーラビリティ**: コンテンツが増えても検証時間は増加しない
2. **関心の分離**: バリデーターのロジックテストと、コンテンツのバリデーションを分離
3. **CI 統合**: PR 時に自動検証、マージをブロックできる
4. **効率性**: 変更されたコンテンツのみ検証するため、無駄がない

### バリデーションの役割分担

```text
┌─────────────────────────────────────────────────────────────┐
│  content.test.ts                                            │
│  - validateContent() のロジックをテスト                      │
│  - モックデータで正常系・異常系を網羅                        │
│  - pnpm test で実行                                         │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  scripts/validate-content-diff.ts                           │
│  - PR で追加・変更されたコンテンツを検証                     │
│  - git diff で差分を抽出                                    │
│  - CI で実行、失敗時はマージをブロック                       │
└─────────────────────────────────────────────────────────────┘
```

## 実装

### 差分バリデーションの流れ

```text
1. git diff origin/main...HEAD で sample-contents.ts の差分を取得
2. 追加された content_id を特定
3. 該当コンテンツを validateContent() で検証
4. エラーがあれば exit code 1 で終了
```

### GitHub Actions ワークフロー

```yaml
- name: Fetch base branch for diff
  run: git fetch origin main --depth=1

- name: Validate content diff
  run: pnpm tsx scripts/validate-content-diff.ts
```

## 結果

### メリット

1. **テストの肥大化を防止**: コンテンツ追加でテストが遅くならない
2. **明確な責務分離**: ロジックテスト vs コンテンツ検証
3. **CI でのゲートキーピング**: 不正なコンテンツのマージを防止

### トレードオフ

1. **既存コンテンツの回帰**: 差分のみ検証するため、既存コンテンツの破損は検出できない
   - 対策: 定期的に全件検証するスケジュールジョブを追加可能
2. **ローカルでの即時フィードバック**: CI 実行まで待つ必要がある
   - 対策: `pnpm tsx scripts/validate-content-diff.ts` をローカルで実行可能

## 関連

- [ADR-0009: AI コンテンツ生成戦略](./0009-ai-content-generation-strategy.md)
- [ADR-0007: 接続マーカー規約](./0007-connection-marker-convention.md)
- `src/lib/validators/content.ts` - バリデーション関数
- `src/lib/validators/content.test.ts` - バリデーターのテスト
