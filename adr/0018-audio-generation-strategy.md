# ADR-0018: 音声生成戦略

## ステータス

採用

## コンテキスト

漢文学習アプリにおいて、中国語（白文）と日本語（音読み）の音声を生成する必要がある。音声生成には以下の要件がある：

1. **中国語音声**: 多音字（説、楽など）の正確な発音
2. **日本語音声**: 自然なイントネーション
3. **ポーズ**: 文の構造に合わせた適切な間
4. **共通化**: 画面表示と音声生成でロジックを共有

## 決定

### 1. 音声合成サービス

**Google Cloud Text-to-Speech** を採用する。

理由：
- 高品質な Wavenet/Neural2 音声
- 中国語・日本語の両方をサポート
- SSML による細かい制御が可能

### 2. 中国語の発音指定

`<phoneme>` タグ + 数字声調ピンインを使用する。

```xml
<phoneme alphabet="pinyin" ph="yue4">說</phoneme>
```

**不採用とした方式:**
- `alphabet="x-pinyin"` → Google Cloud TTS では `pinyin` が正しい
- ピンインテキスト直接指定 → 声調番号が数字として読み上げられる
- アクセント付きピンイン（yuè）→ TTS が認識しない

### 3. 日本語の音声

**音読み（カタカナ）** を使用する。書き下し文は使用しない。

```text
シエツ、ガクジジシュウシ、フエキエツコ...
```

**書き下し文を不採用とした理由:**
- 書き下し文は日本語なので、日本人が違和感なく聞ける品質にするには抑揚の細かい制御が必要になるためめ

**音読みの利点:**
- 画面表示と同じロジック（`getDefaultMeaning().onyomi`）を共有
- 日本語に比べて発音される機会が少ないため抑揚に対して違和感を感じる程度が少ない

### 4. ポーズの配置

中国語と日本語で同じ位置にポーズを挿入する：

| 記号 | 用途 | ポーズ長 |
|------|------|----------|
| スペース | 文節区切り | 1s |
| セミコロン（;） | 句の区切り | 1s |
| セグメント境界 | 発話者切り替え | 1s |
| 句点（。） | 文末 | 1.5s |
| 読点（，、） | 句中 | 1s |

### 5. ルビ生成ロジックの共通化

`src/lib/ruby.ts` にロジックを集約：

```typescript
// 音読み取得（画面・音声で共用）
export function convertToOnyomi(text: string): string

// 訓読み取得（画面で使用）
export function convertToHiragana(text: string): string
```

## 結果

### 良い点

- 中国語の多音字が正確に発音される
- 音読みは漢字学習に適した形式
- 画面と音声でロジックを共有でき、一貫性が保たれる
- ポーズ位置が統一され、中国語と日本語を対比しやすい

### 注意点

- 辞書に登録されていない漢字は音声化できない（フォールバックとして漢字がそのまま出力される）
  - 辞書登録は YAML 追加時のバリデーションで保証している

## 関連

- ADR-0017: Audio Manifest Strategy（音声ファイルの管理）
- ADR-0005: Japanese Ruby Structure（ルビ構造）
