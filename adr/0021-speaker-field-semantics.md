# ADR-0021: speaker フィールドの意味論

## ステータス

承認

## コンテキスト

音声生成において、`speaker` フィールドは音声の声を決定するために使用される。しかし、古典テキストには「顏淵問仁」のように、ナレーション形式で人物の行動を記述するセグメントが存在する。

### 課題

- 「顏淵問仁」のようなセグメントは、顔淵が直接発言しているわけではなく、ナレーターが「顔淵が仁を問うた」と説明している
- しかし、人物の発言マップを作成する際には、このセグメントから「顔淵が質問している」ことを判定したい
- `speaker` フィールドを人物の発言マップ作成にも使いたいが、音声生成ではナレーターの声で読み上げたい

### 例

```yaml
segments:
  - text: 顏淵問仁
    speaker: yanyuan  # 現在の設定（誤り）
```

この場合、音声は「顔淵」の声で生成されるが、実際には顔淵が自分の名前を言っているわけではない。

## 決定

**`speaker` フィールドは音声生成のためのみに使用し、常に実際の発言者のみを指定する。ナレーション形式のセグメントは `speaker: null`（ナレーター）とする。**

### ルール

1. **直接発言**: 人物が直接話している場合のみ `speaker` に人物 ID を設定
   ```yaml
   - text: 學而時習之 不-亦說乎
     speaker: kongzi  # 孔子が直接話している
   ```

2. **ナレーション**: 人物の行動を説明するセグメントは `speaker: null`
   ```yaml
   - text: 顏淵問仁
     speaker: null  # ナレーターが説明している
   ```

3. **人物の特定**: 人物の発言マップを作成する際は、以下の情報を組み合わせて判定
   - `mentioned` フィールド: セグメント内で言及されている人物
   - セグメントの内容: 「問」「曰」「答」などの動詞から行動を判定
   - 前後の文脈: 直前のセグメントの `speaker` や `mentioned`

### 例

```yaml
segments:
  - text: 顏淵問仁
    speaker: null  # ナレーター
  - text: 子曰
    speaker: null  # ナレーター
  - text: 克己復禮為仁
    speaker: kongzi  # 孔子が直接話している
mentioned: [yanyuan]  # 顔淵が言及されている
```

この場合:
- 音声生成: 最初の2セグメントはナレーター（女性）、最後は孔子（男性）
- 発言マップ作成: 「顏淵問仁」から「顔淵が質問している」ことを判定可能（`mentioned` と動詞「問」から）

## 根拠

### この方式を採用する理由

| 観点 | 効果 |
|------|------|
| 音声の正確性 | ナレーションはナレーターの声で読み上げられる（自然） |
| データの一貫性 | `speaker` フィールドの意味が明確（実際の発言者のみ） |
| 可視化の柔軟性 | `mentioned` と内容解析で人物の行動を判定可能 |
| シンプルさ | ルールが明確で、誤用しにくい |

### 代替案

#### A. `speaker` にナレーション対象の人物を設定

**却下理由**: 音声生成で不自然な結果になる（人物が自分の名前を言う）

#### B. `narrated_about` のような別フィールドを追加

**却下理由**: スキーマが複雑になり、既存データの移行が必要

#### C. セグメントタイプ（`type: narration` vs `type: speech`）を追加

**却下理由**: 現時点では過剰設計。必要になったら追加可能

## 影響

### 既存データの修正

以下のようなセグメントを修正する必要がある:

```yaml
# 修正前
- text: 顏淵問仁
  speaker: yanyuan

# 修正後
- text: 顏淵問仁
  speaker: null
```

### 人物発言マップ作成ロジック

人物の発言マップを作成する際は、以下のロジックを使用:

1. `speaker` が人物 ID の場合: その人物の発言として記録
2. `speaker: null` かつ `mentioned` に人物が含まれる場合:
   - セグメント内容を解析（「問」「曰」「答」などの動詞）
   - 文脈から人物の行動を判定
   - 発言マップに記録（発言タイプ: "narration" など）

### MCP ツールへの影響

`write_content_yaml` ツールは、このルールに従って `speaker` を設定する必要がある。Agent が誤ってナレーションに人物 ID を設定しないよう、必要に応じてバリデーションを追加する。

## 関連

- [ADR-0013: コンテンツ入力フォーマット](./0013-content-input-format.md)
- [ADR-0018: 音声生成戦略](./0018-audio-generation-strategy.md)
